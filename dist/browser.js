(()=>{class t{#t;constructor(t){if("string"!=typeof t)throw Error("not a url:",t);this.#t=""+t,a(this,"link")}static from(e){if(e instanceof t)return e;if("string"!=typeof e)throw Error("not a url:",e);return new t(e)}get value(){return this.#t}toString(){return this.#t}toJSON(){return this.#t}toJSONTag(){let t=new String(this.#t),e=l(this);return e&&h(t,e),a(t,"link"),t}}Symbol["JSONTag:Type"]||(Symbol["JSONTag:Type"]=Symbol("@type")),Symbol["JSONTag:Attributes"]||(Symbol["JSONTag:Attributes"]=Symbol("@attributes")),Symbol["JSONTag:Null"]||(Symbol["JSONTag:Null"]=Symbol("@null"));let e=JSON.stringify;function r(t){if("function"==typeof crypto.randomUUID)var e=crypto.randomUUID();else{let t=t=>t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4;"undefined"==typeof crypto&&(t=t=>t^256*Math.random()&15>>t/4);var e="10000000-1000-4000-8000-100000000000".replace(/[018]/g,e=>t(e).toString(16))}return o(t,"id",e),e}let i=t=>null===t||t?.[Symbol["JSONTag:Null"]]==!0,s=e=>{let r=typeof e;return e&&"object"==r&&(e instanceof String||e instanceof Number||i(e))&&void 0!==e[Symbol["JSONTag:Type"]]?r=e[Symbol["JSONTag:Type"]]:Array.isArray(e)?r="array":e instanceof Number?r="number":e instanceof Boolean?r="boolean":e instanceof t&&(r="link"),r},n=["object","array","string","number","boolean","decimal","money","uuid","url","link","date","time","datetime","duration","timestamp","text","blob","color","email","hash","phone","int","int8","int16","int32","int64","uint","uint8","uint16","uint32","uint64","float","float32","float64"],a=(e,r)=>{if("object"!=typeof e)throw TypeError("JSONTag can only set type of objects, convert literals to objects first");if(!n.includes(r))throw TypeError("unknown type "+r);if(Array.isArray(e)){if("array"!==r)throw TypeError('JSONTag can only set type "array" on an array');return}if(e instanceof String||e instanceof Number||i(e))e[Symbol["JSONTag:Type"]]=r;else if("link"==r&&e instanceof t);else if("object"!==r)throw TypeError('JSONTag can only set type "object" on an object')},o=(t,e,r)=>{if(!t||"object"!=typeof t)throw TypeError("JSONTag can only add attributes to objects, convert literals to objects first");if(Array.isArray(r)&&(r=r.join(" ")),"string"!=typeof r)throw TypeError("attribute values must be a string or an array of strings");if(-1!==r.indexOf('"'))throw TypeError('attribute values must not contain " character');-1!==r.indexOf(" ")&&(r=r.split(" "));let i=t[Symbol["JSONTag:Attributes"]]??{};i[e]=r,t[Symbol["JSONTag:Attributes"]]=i},h=(t,e)=>{if(!t||"object"!=typeof t)throw TypeError("JSONTag can only add attributes to objects, convert literals to objects first");if("object"!=typeof e)throw TypeError("attributes param must be an object");Object.keys(e).forEach(r=>{o(t,r,e[r])})},c=(t,e)=>{if(!t||"object"!=typeof t)return;let r=t[Symbol["JSONTag:Attributes"]]??{};return r[e]},l=t=>{if(!t||"object"!=typeof t)return{};let e=t[Symbol["JSONTag:Attributes"]]??{};return Object.assign({},e)},u=t=>{let e=s(t),r=Object.entries(l(t)).map(([t,e])=>(Array.isArray(e)&&(e=e.join(" ")),t+'="'+e+'"')).join(" ");return(r||-1===["object","array","string","number","boolean"].indexOf(e)||(e=""),e||r)?"<"+[e,r].filter(Boolean).join(" ")+">":""};Symbol["JSONTag:Null"]||(Symbol["JSONTag:Null"]=Symbol("@null"));class f{constructor(){return new Proxy(this,{get:(t,e)=>{if(void 0!==t[e])return t[e];if("then"!=e&&"symbol"!=typeof e&&"toJSONTag"!=e)throw console.error("Attempting to get from Null",e,typeof e,JSON.stringify(e)),Error("Attempting to get "+e+" from Null")},set:(t,e,r)=>{if("symbol"==typeof e)return t[e]=r,!0;throw console.error("Attempting to set "+e+" in Null to",r),Error("Attempting to set "+e+" in Null")}})}}class y extends f{get[Symbol["JSONTag:Null"]](){return!0}toString(){return""}toJSON(){return null}}class p{at;ch;input;context;meta;escapee={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"	"};regexes={color:/^(rgb|hsl)a?\((\d+%?(deg|rad|grad|turn)?[,\s]+){2,3}[\s\/]*[\d\.]+%?\)$/i,email:/^[A-Za-z0-9_!#$%&'*+\/=?`{|}~^.-]+@[A-Za-z0-9.-]+$/,uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,decimal:/^\d*\.?\d*$/,money:/^[A-Z]+\$\d*\.?\d*$/,duration:/^(-?)P(?=\d|T\d)(?:(\d+)Y)?(?:(\d+)M)?(?:(\d+)([DW]))?(?:T(?:(\d+)H)?(?:(\d+)M)?(?:(\d+(?:\.\d+)?)S)?)?$/,phone:/^[+]?(?:\(\d+(?:\.\d+)?\)|\d+(?:\.\d+)?)(?:[ -]?(?:\(\d+(?:\.\d+)?\)|\d+(?:\.\d+)?))*(?:[ ]?(?:x|ext)\.?[ ]?\d{1,5})?$/,time:/^(\d{2}):(\d{2})(?::(\d{2}(?:\.\d+)?))?$/,date:/^-?[1-9][0-9]{3,}-([0][1-9]|[1][0-2])-([1-2][0-9]|[0][1-9]|[3][0-1])$/,datetime:/^(\d{4,})-(\d{2})-(\d{2})[T ](\d{2}):(\d{2})(?::(\d{2}(?:\.\d+)?))?Z?$/,range:/^\[-?(\d+\.)?\d+\,-?(\d+\.)?\d+\]$/};constructor(t="http://localhost/"){this.meta={index:{id:new Map},unresolved:new Map,baseURL:t}}error(t){throw new b(t,this)}next(t){return t&&t!==this.ch&&this.error("Expected '"+t+"' instead of '"+this.ch+"'"),this.ch=this.input.charAt(this.at),this.at+=1,this.ch}number(t){let e="";for("-"===this.ch&&(e="-",this.next("-"));this.ch>="0"&&this.ch<="9";)e+=this.ch,this.next();if("."===this.ch)for(e+=".";this.next()&&this.ch>="0"&&this.ch<="9";)e+=this.ch;if("e"===this.ch||"E"===this.ch)for(e+=this.ch,this.next(),("-"===this.ch||"+"===this.ch)&&(e+=this.ch,this.next());this.ch>="0"&&this.ch<="9";)e+=this.ch,this.next();let r=new Number(e).valueOf();if(t)switch(t){case"int":this.isInt(e);break;case"uint":this.isInt(e,[0,1/0]);break;case"int8":this.isInt(e,[-128,127]);break;case"uint8":this.isInt(e,[0,255]);break;case"int16":this.isInt(e,[-32768,32767]);break;case"uint16":this.isInt(e,[0,65535]);break;case"int32":this.isInt(e,[-2147483648,2147483647]);break;case"uint32":this.isInt(e,[0,4294967295]);break;case"timestamp":case"int64":this.isBigInt(e,[BigInt("-9223372036854775808"),BigInt("9223372036854775807")]);break;case"uint64":this.isBigInt(e,[0,BigInt("18446744073709551615")]);break;case"float":this.isFloat(e);break;case"float32":this.isFloat(e,[-34e37,34e37]);break;case"float64":this.isFloat(e,[-17e307,17e307]);break;case"number":break;default:this.typeError(t,e)}return r}typeError(t,e){this.error("Syntax error, expected "+t+", got: "+e)}isFloat(t,e){let r=new Number(parseFloat(t)),i=r.toString();t!==i&&this.error("Syntax Error: expected float value"),e&&("number"==typeof e[0]&&r<e[0]&&this.error("Syntax Error: float value out of range"),"number"==typeof e[1]&&r>e[1]&&this.error("Syntax Error: float value out of range"))}isBigInt(t,e){let r=BigInt(t),i=r.toString();t!==i&&this.error("Syntax Error: expected integer value"),e&&(("number"==typeof e[0]||"bigint"==typeof e[0])&&r<e[0]&&this.error("Syntax Error: integer value out of range"),("number"==typeof e[1]||"bigint"==typeof e[1])&&r>e[1]&&this.error("Syntax Error: integer value out of range"))}isInt(t,e){let r=new Number(parseInt(t)),i=r.toString();t!==i&&this.error("Syntax Error: expected integer value"),e&&("number"==typeof e[0]&&r<e[0]&&this.error("Syntax Error: integer value out of range"),"number"==typeof e[1]&&r>e[1]&&this.error("Syntax Error: integer value out of range"))}isColor(t){let e=!1;return"#"===t.charAt(0)?(e=[3,4,6,8].indexOf((t=t.substring(1)).length)>-1&&!isNaN(parseInt(t,16))).toString(16)!==t&&this.typeError("color",t):e=this.regexes.color.test(t),e||this.typeError("color",t),!0}isType(t,e){return this.regexes[t].test(e)||this.typeError(t,e),!0}isUrl(t){try{return new URL(t,this.meta.baseURL),!0}catch(e){this.typeError("url",t)}}checkStringType(t,e){if(t){switch(t){case"object":case"array":case"int8":case"uint8":case"int16":case"uint16":case"int32":case"uint32":case"int64":case"uint64":case"int":case"uint":case"float32":case"float64":case"float":case"timestamp":this.typeError(t,e);break;case"uuid":return this.isType("uuid",e);case"decimal":return this.isType("decimal",e);case"money":return this.isType("money",e);case"url":return this.isUrl(e);case"link":case"string":case"text":case"blob":case"hash":return!0;case"color":return this.isColor(e);case"email":return this.isType("email",e);case"duration":return this.isType("duration",e);case"phone":return this.isType("phone",e);case"range":return this.isType("range",e);case"time":return this.isType("time",e);case"date":return this.isType("date",e);case"datetime":return this.isType("datetime",e)}this.error("Syntax error: unknown tagName "+t)}}string(t){let e="",r,i,s;for('"'!==this.ch&&this.error("Syntax Error"),this.next('"');this.ch;){if('"'===this.ch)return this.next(),this.checkStringType(t,e),e;if("\\"===this.ch){if(this.next(),"u"===this.ch){for(i=0,s=0;i<4&&(r=parseInt(this.next(),16),this.isFinite(r));i++)s=16*s+r;e+=String.fromCharCode(s),this.next()}else if("string"==typeof this.escapee[this.ch])e+=this.escapee[this.ch],this.next();else break}else e+=this.ch,this.next()}this.error("Syntax error: incomplete string")}tag(){let t,e,r={attributes:{}};for("<"!==this.ch&&this.error("Syntax Error"),this.next("<"),(t=this.word())||this.error("Syntax Error: expected tag name"),r.tagName=t,this.whitespace();this.ch;){if(">"===this.ch)return this.next(">"),r;(t=this.word())||this.error("Syntax Error: expected attribute name"),this.whitespace(),this.next("="),this.whitespace(),e=this.string(),r.attributes[t]=e,this.whitespace()}this.error("Syntax Error: unexpected end of input")}whitespace(){for(;this.ch;)switch(this.ch){case" ":case"	":case"\r":case"\n":this.next();break;default:return}}word(){let t="";for(this.ch>="a"&&this.ch<="z"||this.ch>="A"&&this.ch<="Z"?(t+=this.ch,this.next()):this.error("Syntax Error: expected word");this.ch>="a"&&this.ch<="z"||this.ch>="A"&&this.ch<="Z"||this.ch>="0"&&this.ch<="9"||"_"==this.ch;)t+=this.ch,this.next();return t}boolOrNull(t){let e=this.word();switch(e&&"string"==typeof e||this.error('Syntax error: expected boolean or null, got "'+e+'"'),e.toLowerCase()){case"true":return t&&"boolean"!==t&&this.typeError(t,e),!0;case"false":return t&&"boolean"!==t&&this.typeError(t,e),!1;case"null":return null;default:this.error('Syntax error: expected boolean or null, got "'+e+'"')}}checkUnresolved(t,e,r){if("link"===s(t)){let i=""+t,s=this.meta.unresolved.get(i);void 0===s&&(this.meta.unresolved.set(i,[]),s=this.meta.unresolved.get(i)),(s=s.filter(t=>t.key!=r||t.src.deref()!=e)).push({src:new WeakRef(e),key:r}),this.meta.unresolved.set(i,s)}}removeUnresolved(t,e,r){if("link"===s(t)){let i=""+t,s=this.meta.unresolved.get(i);void 0!==s&&((s=s.filter(t=>t.key!=r||t.src.deref()!=e)).length?this.meta.unresolved.set(i,s):this.meta.unresolved.delete(i))}}array(){let t,e=[];if("["!==this.ch&&this.error("Syntax error"),this.next("["),this.whitespace(),"]"===this.ch)return this.next("]"),e;for(;this.ch;){if(t=this.value(),this.checkUnresolved(t,e,e.length),e.push(t),this.whitespace(),"]"===this.ch)return this.next("]"),e;this.next(","),this.whitespace()}this.error("Input stopped early")}object(){let t,e,r={};if("{"!==this.ch&&this.error("Syntax Error"),this.next("{"),this.whitespace(),"}"===this.ch)return this.next("}"),r;for(;this.ch;){if("__proto__"===(t=this.string())&&this.error("Attempt at prototype pollution"),this.whitespace(),this.next(":"),e=this.value(),r[t]=e,this.checkUnresolved(e,r,t),this.whitespace(),"}"===this.ch)return this.next("}"),r;this.next(","),this.whitespace()}this.error("Input stopped early")}value(){let t,e,r;switch(this.whitespace(),"<"===this.ch&&(r=(t=this.tag()).tagName,this.whitespace()),this.ch){case"{":r&&"object"!==r&&this.typeError(r,this.ch),e=this.object();break;case"[":r&&"array"!==r&&this.typeError(r,this.ch),e=this.array();break;case'"':e=this.string(r);break;case"-":e=this.number(r);break;default:e=this.ch>="0"&&this.ch<="9"?this.number(r):this.boolOrNull(r)}if(t){if(null===e&&(e=new y),"object"!=typeof e)switch(typeof e){case"string":e=new String(e);break;case"number":e=new Number(e);break;default:this.error("Syntax Error: unexpected type "+typeof e)}t.tagName&&a(e,t.tagName),t.attributes&&(h(e,t.attributes),t.attributes?.id&&this.meta.index.id.set(t.attributes.id,new WeakRef(e)))}return e}walk(t,e,r){var i,n,a=t[e];if(null!==a&&"object"==typeof a&&!(a instanceof String||a instanceof Number||a instanceof Boolean)){for(i in a)if(Object.prototype.hasOwnProperty.call(a,i)){if(void 0!==(n=this.walk(a,i,r))&&(void 0===a[i]||a[i]!==n)){let t=a[i];a[i]=n,"link"===s(n)&&(this.removeUnresolved(t,a,i),this.checkUnresolved(n,a,i))}else void 0===n&&delete a[i]}}return r.call(t,e,a,this.meta)}replaceLink(t,e){if(void 0!==e){let r=t.src.deref();if(void 0!==r&&"link"===s(r[t.key]))return r[t.key]=e,!0}}resolveLinks(){this.meta.index.id.size>this.meta.unresolved.size?this.meta.unresolved.forEach((t,e)=>{let r=this.meta.index.id.get(e)?.deref();void 0!==r&&t.forEach((e,i)=>{this.replaceLink(e,r)&&delete t[i]})}):this.meta.index.id.forEach((t,e)=>{let r=t.deref(),i=this.meta.unresolved.get(e);void 0!==r&&void 0!==i&&(i.forEach(t=>{this.replaceLink(t,r)}),this.meta.unresolved.delete(e))})}parse(t,e){this.at=0,this.ch=" ",this.input=t;let r=this.value();return this.whitespace(),this.ch&&this.error("Syntax error"),"function"==typeof e&&this.walk({"":r},"",e),this.resolveLinks(),r}}class b extends Error{constructor(t,e){super(t),this.input=e.input.substring(e.at-100,e.at+100),this.at=e.at}}window.JSONTag={stringify:(t,i=null,n="")=>{let o=new WeakMap,f="",y="";if("number"==typeof n?f+=" ".repeat(n):"string"==typeof n&&(f=n),i&&"function"!=typeof i&&("object"!=typeof i||"number"!=typeof i.length))throw Error("JSONTag.stringify");let p=t=>{let r=y;y+=f;let s="",n="",a=Object.keys(t);Array.isArray(i)&&(a=a.filter(t=>-1!==i.indexOf(t))),y&&(s="\n"+y,n="\n"+r);let o=s+a.map(r=>void 0===t[r]?null:e(r)+":"+g(r,t)).filter(Boolean).join(","+s)+n;return y=r,o},b=t=>{let e=y,r="",i="";(y+=f)&&(r="\n"+y,i="\n"+e);let s=r+t.map((e,r)=>g(r,t)).join(","+r)+i;return y=e,s},d=new WeakMap,g=(t,f)=>{let y=f[t];if("function"==typeof i&&""!==t&&(y=i.call(f,t,y)),"object"===s(y)&&o.has(y)){let t=c(y,"id");return t||(t=r(y)),'<link>"'+t+'"'}if(null==y)return"null";if("object"===s(y)&&o.set(y,!0),"function"==typeof y.toJSONTag)y=y.toJSONTag();else if("function"==typeof y.toJSON){let t=s(y),e=l(y),r=y.toJSON();if("string"==typeof r)y=new String(r);else if("number"==typeof r)y=new Number(r);else{if(null==r)return null!==y?u(y)+"null":"null";y=r}e&&h(y,e),t&&a(y,t)}if(Array.isArray(y))return u(y)+"["+b(y)+"]";if(!(y instanceof Object))return e(y,i,n);switch(s(y)){case"string":case"decimal":case"money":case"link":case"text":case"blob":case"color":case"email":case"hash":case"duration":case"phone":case"url":case"uuid":case"date":case"time":case"datetime":return u(y)+e(""+y,i,n);case"int":case"uint":case"int8":case"uint8":case"int16":case"uint16":case"int32":case"uint32":case"int64":case"uint64":case"float":case"float32":case"float64":case"timestamp":case"number":case"boolean":return u(y)+e(y,i,n);case"array":let d=b(y);return u(y)+"["+d+"}";case"object":if(null===y)return"null";let g=p(y);return u(y)+"{"+g+"}";default:throw Error(s(y)+" type not yet implemented")}};!function t(e){if(Array.isArray(e))for(let r of e)t(r);else if(e&&"object"==typeof e){if(d.has(e))c(e,"id")||r(e);else for(let r in d.set(e,!0),e)t(e[r])}}(t);let m=g("",{"":t});return m},parse:(t,e,r)=>{let i=new p;return r&&(i.meta=r),i.parse(t,e)},Parser:p,getType:s,setType:a,getTypeString:u,setAttribute:o,getAttribute:c,addAttribute:(t,e,r)=>{if("string"!=typeof r)throw TypeError("attribute values must be a string");if(-1!==r.indexOf('"'))throw TypeError('attribute values must not contain " characters');if(!t||"object"!=typeof t)throw TypeError("JSONTag can only add attributes to objects, convert literals to objects first");let i=t[Symbol["JSONTag:Attributes"]]??{};void 0===i[e]?o(t,e,r):(Array.isArray(i[e])||(i[e]=[i[e]]),r=-1!==r.indexOf(" ")?r.split(" "):[r],i[e]=i[e].concat(r),t[Symbol["JSONTag:Attributes"]]=i)},removeAttribute:(t,e)=>{if(!t||"object"!=typeof t)return;let r=t[Symbol["JSONTag:Attributes"]];void 0!==r?.[e]&&delete r[e]},getAttributes:l,setAttributes:h,getAttributesString:t=>Object.entries(l(t)).map(([t,e])=>(Array.isArray(e)&&(e=e.join(" ")),t+'="'+e+'"')).join(" "),isNull:i,clone:t=>{let e=u(t),r=s(t),i=l(t),n=function(t){return t instanceof Number?new Number(t):t instanceof Boolean?new Boolean(t):t instanceof String?new String(t):Array.isArray(t)?[...t]:{...t}}(t);return e&&(a(n,r),i&&h(n,i)),n},Link:t,Null:y}})();
//# sourceMappingURL=browser.js.map
